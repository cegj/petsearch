<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PetSearch</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="../style-guide.css">
  <link rel="stylesheet" href="index.css">
  <link rel="stylesheet" href="gallery.css">
</head>

<body>
  <!-- Carrega plugin LeafLet para renderizar mapa -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  
  <nav class="navbar navbar-expand-lg navbar-light bg-blue text-uppercase">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
        aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav">
          <a class="nav-link text-white" aria-current="page" href="/">Home</a>
          <a class="nav-link text-white active" href="/lost-pets">Perdidos</a>
          <a class="nav-link text-white" href="/adoption-pets">Adoção</a>
          <a class="nav-link text-white" href="/contact">Contato</a>
        </div>
      </div>
    </div>
  </nav>
  <div class="d-flex flex-column flex-lg-row justify-content-center align-items-center px-5 px-lg-0 pb-4 bg-blue">
    <img class="header-image" src="../assets/cachorro-01.png" />
    <div class="d-flex flex-column align-items-center align-items-lg-start header-right-side">
      <img class="logo-small mb-4" src="../assets/logo-negativa.png" />
      <span class="header-title text-white text-uppercase text-center">Pet perdido?</span>
    </div>
  </div>
  <div class="form-input d-flex justify-content-center bg-shadow-grey">
    <select name="species" id="species" class="my-3">
      <option value="" selected>Selecione a espécie</option>
      <option value="canino">Cachorro</option>
      <option value="felino">Gato</option>
      <option value="aves">Ave</option>
      <option value="outro">Outro</option>
    </select>
  </div>
  <div class="d-flex justify-content-center px-5 py-5 bg-shadow-grey">
    <div class="row justify-content-evenly" id="pets-gallery">
    </div>
  </div>
  <div id="map"></div>

  <script type="text/javascript">
    function insertPet(pet) {
      try {
        const petsElement = document.getElementById('pets-gallery');

        petsElement.insertAdjacentHTML('beforeend', `
          <a class="col-12 col-lg-2 d-flex flex-column justify-content-center grid-picture" href="lost-details.html?id=${pet.id}">
            <img class="gallery-img" src="${pet.imageUrl}" />
            <div
              class="d-flex flex-column align-items-center justify-content-center bg-strong-grey grid-picture-description">
              <p>${pet.name}</p>
              <p>${pet.race} ${pet.color}</p>
              <p>${pet.city}/${pet.state}</p>
            </div>
          </a>
        `);
      } catch (e) {
        console.log('erro')
        console.log(e);
      }
    }

    async function fetchPets() {
      try {
        const protocol = window.location.protocol
        const host = window.location.hostname
        const port = window.location.port
        const url = port ? `${protocol}//${host}:${port}/api/lost-pets?returned=false` : `${protocol}//${host}/api/lost-pets?returned=false`

        const response = await fetch(url);
        const pets = await response.json();
        return pets
      } catch (e) {
        console.log('erro')
        console.log(e);
      }
    }

    function cleanPetsGallery() {
      const petsElement = document.getElementById('pets-gallery');
      while (petsElement.firstChild) {
        petsElement.removeChild(petsElement.lastChild);
      }
    }

    function renderPets(pets) {
      cleanPetsGallery()
      pets.forEach(pet => {
        MapMarkersLayer.clearLayers();
        insertPet(pet);
        insertMapMarker(pet);
      })
    }

    async function main() {
      const pets = await fetchPets();
      renderPets(pets)

      const species = document.getElementById('species')
      species.addEventListener('change', function () {
        if (this.value) {
          console.log(this.value)
          renderPets(pets.filter((pet) => {
            return pet.species === this.value
          }))
        } else {
          renderPets(pets)
        }
      });
    }

    function renderMap() {
      const map = L.map('map', {
        center: [-19.912998, -43.940933],
        zoom: 11,
        scrollWheelZoom: false
      })

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      return map;
    }

    function insertMapMarker(pet) {

      const address = `${pet.street} - ${pet.neighborhood}, ${pet.city}/${pet.state}`;

      fetch(`https://nominatim.openstreetmap.org/search.php?q=${address}&format=jsonv2`)
        .then(res => res.json())
        .then((addressInfo) => {
          addressInfo = addressInfo[0]
          const marker = L.marker([addressInfo.lat, addressInfo.lon])
            .addTo(MapMarkersLayer)
            .bindPopup(
              `<a href="lost-details.html?id=${pet.id}">${pet.name}</a>
                              <br>
                              Espécie: ${pet.species}
                              <br>
                              ${pet.street}, ${pet.neighborhood}
                              `)
                            })
      }

      const map = renderMap();
      let MapMarkersLayer = L.layerGroup().addTo(map);

    main()
  </script>
</body>

</html>